import Onyx from 'react-native-onyx';
import type {OnyxUpdate} from 'react-native-onyx';
import type {ValueOf} from 'type-fest';
import type {LocalizedTranslate} from '@components/LocaleContextProvider';
import * as API from '@libs/API';
import type {
    ExportTravelInvoiceStatementCSVParams,
    GetTravelInvoiceStatementPDFParams,
    OpenPolicyTravelPageParams,
    SetTravelInvoicingSettlementAccountParams,
    ToggleTravelInvoicingParams,
    UpdateTravelInvoicingSettlementFrequencyParams,
} from '@libs/API/parameters';
import {READ_COMMANDS, WRITE_COMMANDS} from '@libs/API/types';
import * as ApiUtils from '@libs/ApiUtils';
import enhanceParameters from '@libs/Network/enhanceParameters';
import * as ErrorUtils from '@libs/ErrorUtils';
import fileDownload from '@libs/fileDownload';
import {getTravelInvoicingCardSettingsKey} from '@libs/TravelInvoicingUtils';
import CONST from '@src/CONST';
import ONYXKEYS from '@src/ONYXKEYS';

/**
 * Opens the Travel page for a policy and fetches Travel Invoicing data.
 * Sets the isLoading state for the card settings while the API request is in flight.
 */
function openPolicyTravelPage(policyID: string, workspaceAccountID: number) {
    const optimisticData: Array<OnyxUpdate<typeof ONYXKEYS.COLLECTION.PRIVATE_EXPENSIFY_CARD_SETTINGS>> = [
        {
            onyxMethod: Onyx.METHOD.MERGE,
            key: `${ONYXKEYS.COLLECTION.PRIVATE_EXPENSIFY_CARD_SETTINGS}${workspaceAccountID}`,
            value: {
                isLoading: true,
            },
        },
    ];

    const successData: Array<OnyxUpdate<typeof ONYXKEYS.COLLECTION.PRIVATE_EXPENSIFY_CARD_SETTINGS>> = [
        {
            onyxMethod: Onyx.METHOD.MERGE,
            key: `${ONYXKEYS.COLLECTION.PRIVATE_EXPENSIFY_CARD_SETTINGS}${workspaceAccountID}`,
            value: {
                isLoading: false,
            },
        },
    ];

    const failureData: Array<OnyxUpdate<typeof ONYXKEYS.COLLECTION.PRIVATE_EXPENSIFY_CARD_SETTINGS>> = [
        {
            onyxMethod: Onyx.METHOD.MERGE,
            key: `${ONYXKEYS.COLLECTION.PRIVATE_EXPENSIFY_CARD_SETTINGS}${workspaceAccountID}`,
            value: {
                isLoading: false,
            },
        },
    ];

    const params: OpenPolicyTravelPageParams = {
        policyID,
    };

    API.read(READ_COMMANDS.OPEN_POLICY_TRAVEL_PAGE, params, {optimisticData, successData, failureData});
}

/**
 * Sets the settlement account for Travel Invoicing.
 * Updates the paymentBankAccountID in the Travel Invoicing card settings.
 */
function setTravelInvoicingSettlementAccount(policyID: string, workspaceAccountID: number, settlementBankAccountID: number, previousPaymentBankAccountID?: number) {
    const cardSettingsKey = getTravelInvoicingCardSettingsKey(workspaceAccountID);

    // Determine if we need to set the default frequency:
    // - When enabling for the first time (no previous account): default to monthly
    // - When disabling (zero bank account): clear the frequency
    // - When changing accounts (previous account exists): don't touch frequency (undefined = no change)
    const isFirstEnable = settlementBankAccountID !== 0 && !previousPaymentBankAccountID;
    const isDisabling = settlementBankAccountID === 0;

    let monthlySettlementDate: Date | null | undefined;
    if (isFirstEnable) {
        monthlySettlementDate = new Date();
    } else if (isDisabling) {
        monthlySettlementDate = null;
    }
    // Otherwise leave undefined - Onyx.merge will not overwrite existing value

    const optimisticData: Array<OnyxUpdate<typeof ONYXKEYS.COLLECTION.PRIVATE_EXPENSIFY_CARD_SETTINGS>> = [
        {
            onyxMethod: Onyx.METHOD.MERGE,
            key: cardSettingsKey,
            value: {
                paymentBankAccountID: settlementBankAccountID,
                previousPaymentBankAccountID,
                monthlySettlementDate,
                isLoading: true,
                pendingFields: {
                    paymentBankAccountID: CONST.RED_BRICK_ROAD_PENDING_ACTION.UPDATE,
                },
                errorFields: {
                    paymentBankAccountID: null,
                },
            },
        },
    ];

    const successData: Array<OnyxUpdate<typeof ONYXKEYS.COLLECTION.PRIVATE_EXPENSIFY_CARD_SETTINGS>> = [
        {
            onyxMethod: Onyx.METHOD.MERGE,
            key: cardSettingsKey,
            value: {
                paymentBankAccountID: settlementBankAccountID,
                previousPaymentBankAccountID: null,
                monthlySettlementDate,
                isLoading: false,
                pendingFields: {
                    paymentBankAccountID: null,
                },
                errorFields: {
                    paymentBankAccountID: null,
                },
            },
        },
    ];

    const failureData: Array<OnyxUpdate<typeof ONYXKEYS.COLLECTION.PRIVATE_EXPENSIFY_CARD_SETTINGS>> = [
        {
            onyxMethod: Onyx.METHOD.MERGE,
            key: cardSettingsKey,
            value: {
                // Keep the attempted value visible (grayed out) until error is dismissed
                paymentBankAccountID: settlementBankAccountID,
                previousPaymentBankAccountID,
                monthlySettlementDate,
                isLoading: false,
                pendingFields: {
                    paymentBankAccountID: CONST.RED_BRICK_ROAD_PENDING_ACTION.UPDATE,
                },
                errorFields: {
                    paymentBankAccountID: ErrorUtils.getMicroSecondOnyxErrorWithTranslationKey('common.genericErrorMessage'),
                },
            },
        },
    ];

    const params: SetTravelInvoicingSettlementAccountParams = {
        policyID,
        settlementBankAccountID,
    };

    API.write(WRITE_COMMANDS.SET_TRAVEL_INVOICING_SETTLEMENT_ACCOUNT, params, {optimisticData, successData, failureData});
}

/**
 * Clears any errors from the Travel Invoicing settlement account settings.
 * Also resets the paymentBankAccountID to the previous valid value (or null if none existed).
 */
function clearTravelInvoicingSettlementAccountErrors(workspaceAccountID: number, paymentBankAccountID: number | null) {
    Onyx.merge(getTravelInvoicingCardSettingsKey(workspaceAccountID), {
        paymentBankAccountID,
        previousPaymentBankAccountID: null,
        pendingFields: {
            paymentBankAccountID: null,
        },
        errorFields: {
            paymentBankAccountID: null,
        },
    });
}

/**
 * Updates the settlement frequency for Travel Invoicing.
 * Optimistically updates the monthlySettlementDate based on the selected frequency.
 * Supports offline behavior - changes are queued and synced when back online.
 */
function updateTravelInvoiceSettlementFrequency(workspaceAccountID: number, frequency: ValueOf<typeof CONST.EXPENSIFY_CARD.FREQUENCY_SETTING>, currentMonthlySettlementDate?: Date) {
    const cardSettingsKey = getTravelInvoicingCardSettingsKey(workspaceAccountID);

    // If Monthly, set date (optimistically today). If Daily, set null.
    const monthlySettlementDate = frequency === CONST.EXPENSIFY_CARD.FREQUENCY_SETTING.MONTHLY ? new Date() : null;

    const optimisticData: Array<OnyxUpdate<typeof ONYXKEYS.COLLECTION.PRIVATE_EXPENSIFY_CARD_SETTINGS>> = [
        {
            onyxMethod: Onyx.METHOD.MERGE,
            key: cardSettingsKey,
            value: {
                monthlySettlementDate,
                previousMonthlySettlementDate: currentMonthlySettlementDate,
                pendingFields: {
                    monthlySettlementDate: CONST.RED_BRICK_ROAD_PENDING_ACTION.UPDATE,
                },
                errorFields: {
                    monthlySettlementDate: null,
                },
            },
        },
    ];

    const successData: Array<OnyxUpdate<typeof ONYXKEYS.COLLECTION.PRIVATE_EXPENSIFY_CARD_SETTINGS>> = [
        {
            onyxMethod: Onyx.METHOD.MERGE,
            key: cardSettingsKey,
            value: {
                monthlySettlementDate,
                previousMonthlySettlementDate: null,
                pendingFields: {
                    monthlySettlementDate: null,
                },
                errorFields: {
                    monthlySettlementDate: null,
                },
            },
        },
    ];

    const failureData: Array<OnyxUpdate<typeof ONYXKEYS.COLLECTION.PRIVATE_EXPENSIFY_CARD_SETTINGS>> = [
        {
            onyxMethod: Onyx.METHOD.MERGE,
            key: cardSettingsKey,
            value: {
                monthlySettlementDate,
                previousMonthlySettlementDate: currentMonthlySettlementDate ?? null,
                pendingFields: {
                    monthlySettlementDate: null,
                },
                errorFields: {
                    monthlySettlementDate: ErrorUtils.getMicroSecondOnyxErrorWithTranslationKey('common.genericErrorMessage'),
                },
            },
        },
    ];

    const params: UpdateTravelInvoicingSettlementFrequencyParams = {
        domainAccountID: workspaceAccountID,
        settlementFrequency: frequency,
    };

    API.write(WRITE_COMMANDS.UPDATE_TRAVEL_INVOICE_SETTLEMENT_FREQUENCY, params, {optimisticData, successData, failureData});
}

/**
 * Clears any errors from the Travel Invoicing settlement frequency settings.
 */
function clearTravelInvoicingSettlementFrequencyErrors(workspaceAccountID: number, monthlySettlementDate: Date | null | undefined) {
    Onyx.merge(getTravelInvoicingCardSettingsKey(workspaceAccountID), {
        monthlySettlementDate: monthlySettlementDate ?? null,
        previousMonthlySettlementDate: null,
        pendingFields: {
            monthlySettlementDate: null,
        },
        errorFields: {
            monthlySettlementDate: null,
        },
    });
}

/**
 * Toggles Travel Invoicing on or off for a workspace.
 * Sets isEnabled flag optimistically, backend confirms via onyx data.
 */
function toggleTravelInvoicing(policyID: string, workspaceAccountID: number, enabled: boolean) {
    const cardSettingsKey = getTravelInvoicingCardSettingsKey(workspaceAccountID);

    const optimisticData: OnyxUpdate[] = [
        {
            onyxMethod: Onyx.METHOD.MERGE,
            key: cardSettingsKey,
            value: {
                isEnabled: enabled,
                [CONST.TRAVEL.PROGRAM_TRAVEL_US]: {
                    isEnabled: enabled,
                },
                pendingAction: CONST.RED_BRICK_ROAD_PENDING_ACTION.UPDATE,
                errors: null,
            },
        },
    ];

    const successData: OnyxUpdate[] = [
        {
            onyxMethod: Onyx.METHOD.MERGE,
            key: cardSettingsKey,
            value: {
                pendingAction: null,
                [CONST.TRAVEL.PROGRAM_TRAVEL_US]: {
                    isEnabled: enabled,
                },
            },
        },
    ];

    // On failure: revert isEnabled and show error
    const failureData: OnyxUpdate[] = [
        {
            onyxMethod: Onyx.METHOD.MERGE,
            key: cardSettingsKey,
            value: {
                isEnabled: !enabled,
                [CONST.TRAVEL.PROGRAM_TRAVEL_US]: {
                    isEnabled: !enabled,
                },
                pendingAction: null,
                errors: ErrorUtils.getMicroSecondOnyxErrorWithTranslationKey('common.genericErrorMessage'),
            },
        },
    ];

    const params: ToggleTravelInvoicingParams = {
        policyID,
        enabled,
    };

    API.write(WRITE_COMMANDS.TOGGLE_TRAVEL_INVOICING, params, {optimisticData, successData, failureData});
}

/**
 * Clears any errors from the Travel Invoicing toggle action.
 */
function clearToggleTravelInvoicingErrors(workspaceAccountID: number) {
    Onyx.merge(getTravelInvoicingCardSettingsKey(workspaceAccountID), {
        errors: null,
        pendingAction: null,
    });
}

/**
 * Clears the travel invoice statement state.
 * Useful for recovering from stuck states.
 */
function clearTravelInvoiceStatementState() {
    Onyx.merge(ONYXKEYS.TRAVEL_INVOICE_STATEMENT, {
        isGenerating: false,
    });
}

/**
 * Generates a Travel Invoice Statement PDF for the given policy and date range.
 * Uses optimistic updates to track generation status in Onyx.
 */
function generateTravelInvoiceStatementPDF(policyID: string, startDate: string, endDate: string) {
    const parameters: GetTravelInvoiceStatementPDFParams = {
        policyID,
        startDate,
        endDate,
    };

    // Note: Backend returns onyxData with isGenerating: false AND the PDF filename,
    // so we don't need successData here - the backend response handles it.
    API.read(READ_COMMANDS.GET_TRAVEL_INVOICE_STATEMENT_PDF, parameters, {
        optimisticData: [
            {
                onyxMethod: Onyx.METHOD.MERGE,
                key: ONYXKEYS.TRAVEL_INVOICE_STATEMENT,
                value: {
                    isGenerating: true,
                },
            },
        ],
        failureData: [
            {
                onyxMethod: Onyx.METHOD.MERGE,
                key: ONYXKEYS.TRAVEL_INVOICE_STATEMENT,
                value: {
                    isGenerating: false,
                },
            },
        ],
    });
}

/**
 * Exports Travel Invoice Statement data as CSV for the given policy and date range.
 * Downloads the file directly using fileDownload utility.
 */
function exportTravelInvoiceStatementCSV(policyID: string, startDate: string, endDate: string, translate: LocalizedTranslate) {
    const finalParameters = enhanceParameters(READ_COMMANDS.EXPORT_TRAVEL_INVOICE_STATEMENT_CSV, {
        policyID,
        startDate,
        endDate,
    } as ExportTravelInvoiceStatementCSVParams);

    const formData = new FormData();
    for (const [key, value] of Object.entries(finalParameters)) {
        formData.append(key, String(value));
    }

    const filename = `Travel_Statement_${startDate}_${endDate}.csv`;
    const commandURL = ApiUtils.getCommandURL({command: READ_COMMANDS.EXPORT_TRAVEL_INVOICE_STATEMENT_CSV});

    fileDownload(translate, commandURL, filename, '', false, formData, CONST.NETWORK.METHOD.POST);
}

export {
    openPolicyTravelPage,
    setTravelInvoicingSettlementAccount,
    clearTravelInvoicingSettlementAccountErrors,
    clearTravelInvoicingSettlementFrequencyErrors,
    updateTravelInvoiceSettlementFrequency,
    toggleTravelInvoicing,
    clearToggleTravelInvoicingErrors,
    clearTravelInvoiceStatementState,
    generateTravelInvoiceStatementPDF,
    exportTravelInvoiceStatementCSV,
};
